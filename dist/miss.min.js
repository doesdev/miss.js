/*
 *  Miss.js - v0.1.0
 *  Make it simple stupid. Web app walkthroughs for maximum user conversion.
 *  https://github.com/musocrat/miss
 *
 *  Made by Andrew Carpenter
 *  Under MIT License
 */
(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};!function(b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A=this;return p=function(a){var d,f,h,i,j,k,m,n,r,s,t,u,v,w;if(p.missies=p.missies||[],p.global||p.settings(a.settings||null),p.site=p.global.app_location||window.location.host||window.location.hostname,m=function(){return{order:"series",background_color:"#f5f5f5",titlebar_color:"#939393",show_on_hover:!0,font_color:"#000"}},e(!1),a.elements){p.off(),h=0,v=a.elements;for(i in v)if(s=v[i],d=m(),k=l(l(d,s),p.global),"welcome"===(r=i.toLowerCase())||"exit"===r)j=o(k.msg),k.title&&j&&p.missies.push(new c(r,h+=1,k,k.title,j));else for(w=b.querySelectorAll.call(b,i),t=0,u=w.length;u>t;t++)f=w[t],n=k.title||f.dataset.missTitle||null,j=o(f.dataset.missMsg)||o(k.msg)||null,n&&j&&p.missies.push(new c(f,h+=1,k,n,j));return y(),g(),q()}},c=function(){function c(b,c,d,e,f){switch(this.off=a(this.off,this),this.on=a(this.on,this),this.bindOff=a(this.bindOff,this),this.bindOn=a(this.bindOn,this),this.resize=a(this.resize,this),this.canvasExtract=a(this.canvasExtract,this),this.highlight=a(this.highlight,this),this.buildBorder=a(this.buildBorder,this),this.boxSizing=a(this.boxSizing,this),this.buildBox=a(this.buildBox,this),b){case"welcome":this.order=0,this.el=null;break;case"exit":this.order=1e3,this.el=null;break;default:this.order=parseInt(b.dataset.missOrder,10)||parseInt(d.order,10)||100+c,this.el=b}this.opts=d,this.title=e,this.msg=f,this.index=c,this.buildBox(),this.buildBorder()}return c.prototype.buildBox=function(){var a,c,d,e,f,g,h,i;return a=b.createElement("div"),a.id="miss_"+this.order,a.className="miss-box popover",a.style.position="fixed",a.style.overflow="hidden",a.style.zIndex=this.opts.z_index+1,i=b.createElement("div"),i.className="miss-titlebar popover-title",c='<span style="float:right;cursor:pointer;" onclick="miss.off()"               class="miss-close close" aria-hidden="true">&times;</span>',i.innerHTML=this.title+c,d=b.createElement("div"),d.className="miss-msg popover-content",d.style.overflow="auto",d.style.height="100%",d.innerHTML=this.msg,e=b.createElement("div"),e.id="miss_nav_"+this.index,e.className="miss-nav",f='<div class="miss-btn-group btn-group">              <button class="miss-prev btn btn-default" onclick="miss.previous();">&#8592 prev</button>              <button class="miss-next btn btn-default" onclick="miss.next();">next &#8594</button>              <button class="miss-done btn btn-primary pull-right" onclick="miss.done();">done</button></div>',g='<p class="miss-step-num text-center"></p>',p.global.theme||(h=j(this.opts.titlebar_color),a.style.backgroundColor=this.opts.background_color,a.style.borderRadius="3px",a.style.border="1px solid rgba("+h.red+", "+h.green+", "+h.blue+", 0.6)",i.style.backgroundColor=this.opts.titlebar_color,i.style.borderTopLeftRadius="3px",i.style.borderTopRightRadius="3px",i.style.padding="8px",e.style.textAlign="center",d.style.padding="8px",g=g.replace(">",' style="text-align:center;">')),e.innerHTML=f+g,a.appendChild(i),d.appendChild(e),a.appendChild(d),x(a,!1),b.body.appendChild(a),this.box=a,this.nav=e,this.boxSizing()},c.prototype.boxSizing=function(){var a,b,c,d,e;return this.el&&(c=k(this.el)),e=z(),a=p.bd.miss_visible||null,b=this.box.miss_visible||null,a||(p.bd.style.visibility="hidden",p.on()),b||(this.box.style.visibility="hidden",x(this.box,!0)),this.box.style.width="",this.box.style.height="",this.box.style.maxWidth=this.opts.box_width||(e.width<600?"85%":"40%"),this.box.style.maxHeight=this.opts.box_height||(e.height<400?"80%":"60%"),this.box.style.width=this.opts.box_width||""+this.box.offsetWidth+"px"||this.box.style.maxWidth,this.box.style.height=this.opts.box_height||""+this.box.offsetHeight+"px"||this.box.style.maxHeight,d=this.el?m(c,this.box.offsetHeight,this.box.offsetWidth):{},this.box.style.top=""+(d.x||z().height/2-this.box.offsetHeight/2)+"px",this.box.style.left=""+(d.y||z().width/2-this.box.offsetWidth/2)+"px",a||(p.bd.style.visibility="",p.off()),b?void 0:(this.box.style.visibility="",x(this.box,!1))},c.prototype.buildBorder=function(){return this.opts.highlight&&this.el?(null==this.border&&(this.border=b.getElementById("miss_hl_"+this.index)||b.createElement("div")),this.border.id="miss_hl_"+this.index,this.border.style.position="fixed",this.opts.highlight&&(this.border.style.border=""+(this.opts.highlight_width||0)+"px solid "+this.opts.highlight_color),x(this.border,this.box.miss_visible||!1),p.bd.appendChild(this.border)):void 0},c.prototype.highlight=function(){var a,b;if(this.opts.highlight&&this.el)return a=k(this.el),b=this.opts.highlight?this.opts.highlight_width:0,this.border.style.top=""+(a.top-b)+"px",this.border.style.left=""+(a.left-b)+"px",this.border.style.width=""+(a.width+b)+"px",this.border.style.height=""+(a.height+b)+"px",x(this.border,this.box.miss_visible||!1)},c.prototype.canvasExtract=function(){var a,c,d;if(this.opts.highlight&&this.el)return a=k(this.el),d=this.opts.highlight?this.opts.highlight_width:0,c=b.getElementById("miss_bd_canvas").getContext("2d"),c.save(),c.globalAlpha=1,c.globalCompositeOperation="destination-out",c.beginPath(),c.fillRect(a.left,a.top,a.width+d,a.height+d),c.restore()},c.prototype.resize=function(){return this.boxSizing(),this.highlight(),this.box.miss_visible?this.canvasExtract():void 0},c.prototype.bindOn=function(a){var b;switch(this.opts.key_modifier.toLowerCase()){case"alt":b="altKey";break;case"ctrl":case"control":b="ctrlKey";break;case"shift":b="shiftKey";break;case"cmd":case"command":case"meta":b="metaKey";break;default:return}return a[b]?this.on(!0):void 0},c.prototype.bindOff=function(){return this.off(!0)},c.prototype.on=function(a){return null==a&&(a=null),p.bd.v&&!a&&p.on(),a&&p.off(),this.highlight(),this.canvasExtract(),a&&x(this.nav,!1),this.border&&x(this.border,!0),x(this.box,!0,a),t(this.box),this.alone=a},c.prototype.off=function(a){return null==a&&(a=null),f(a),this.border&&x(this.border,!1),x(this.box,!1),a&&x(this.nav,!0),a&&p.off(),this.alone=null},c}(),x=function(a,b){return a.style.cssText=a.style.cssText+=b?"display:block !important;":"display:none !important;",a.miss_visible=b},l=function(a,b){var c;for(c in b)a[c]=b[c];return a},s=function(a,b){var c;for(c in a)if(a.hasOwnProperty(c)){if("object"==typeof a[c])return s(a[c],b);if(c===b)return a[c]}},j=function(a){return{red:parseInt(u(a).substring(0,2),16),green:parseInt(u(a).substring(2,4),16),blue:parseInt(u(a).substring(4,6),16)}},u=function(a){return a="#"===a.charAt(0)?a.split("#")[1]:a,3===a.length?a+a:a},y=function(){return p.missies.sort(function(a,b){return a.order-b.order})},e=function(a){var c,d;return(c=b.getElementById("miss_bd"))||(d=p.global,c=b.createElement("div"),c.id="miss_bd",c.style.cssText="position:fixed;z-index:"+d.z_index+";top:0;right:0;bottom:0;left:0;",x(c,!1),b.body.appendChild(c)),p.bd=c,f(),x(c,a)},f=function(){var a,c,d,e,f;return f=z(),e=p.global,(c=b.getElementById("miss_bd_canvas"))||(a=p.bd,c=b.createElement("canvas"),c.id="miss_bd_canvas",a.appendChild(c)),c.width=f.width,c.height=f.height,d=c.getContext("2d"),d.clearRect(0,0,c.width,c.height),d.globalAlpha=e.backdrop_opacity,d.fillStyle="#"+u(e.backdrop_color),d.fillRect(0,0,f.width,f.height)},o=function(a){var c;return/#{(.*?)}/.test(a)?(c=b.querySelector(a.match(/#{(.*?)}/)[1]),x(c,!1),c.innerHTML):a},k=function(a){var b,c;return c=a.getBoundingClientRect(),b=p.global.highlight?p.global.highlight_width:0,{top:c.top-b,right:c.right+b,bottom:c.bottom+b,left:c.left-b,width:c.width||c.right-c.left,height:c.height||c.bottom-c.top}},z=function(){var a;return(a=b.getElementById("miss-size-test"))||(a=b.createElement("div"),a.id="miss-size-test",a.style.cssText="position: fixed;top: 0;left: 0;bottom: 0;right: 0; visibility: hidden;",b.body.appendChild(a)),{height:a.offsetHeight,width:a.offsetWidth}},m=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T;for(k={x:z().height/2,y:z().width/2},o={x:a.height/2,y:a.width/2},i={x:b/2,y:c/2},v={plane:"x",metric:b,mstr:"height",array:t=[],optimal:x=[],diffs:g=[],setup:{top:null,middle:[o.x,"top"],bottom:null}},w={plane:"y",metric:c,mstr:"width",array:u=[],optimal:y=[],diffs:h=[],setup:{left:null,middle:[o.y,"left"],right:null}},E=function(a,b){return a-b},O=[v,w],K=0,N=O.length;N>K;K++){f=O[K],P=f.setup;for(B in P)e=P[B],e?(d=e[0],s=e[1]):(d=0,s=B),l={},G={},l[Object.keys(f.setup)[0]]=Math.abs(a[s]-i[f.plane]-k[f.plane]+d),l[Object.keys(f.setup)[1]]=Math.abs(a[s]-k[f.plane]+d),l[Object.keys(f.setup)[2]]=Math.abs(a[s]+i[f.plane]-k[f.plane]+d),G[Object.keys(f.setup)[0]]=a[s]-f.metric+d,G[Object.keys(f.setup)[1]]=a[s]-i[f.plane]+d,G[Object.keys(f.setup)[2]]=a[s]+d,D=B,f.array.push({diff:l,val:G,position:D});Q=f.array;for(q in Q){F=Q[q],R=F.diff;for(r in R)H=R[r],f.diffs.push(H)}for(f.diffs.sort(E),C=f.setup.middle[1],p=L=0;8>=L;p=++L){j=!1,S=f.array;for(q in S){F=S[q],T=F.diff;for(m in T)if(n=T[m],n===f.diffs[p]&&F.val[m]>=0&&F.val[m]+f.metric<z().width){A=(G=F.val[m])<a[C]+a[f.mstr]&&G+f.metric>a[C],f.optimal.push({val:G,diff:n,position:""+F.position+"_"+m,overlap:A}),j=!0;break}if(j)break}}}for(p=M=0;8>=M&&(!(I=x[p])||!(J=y[p])||I.overlap&&J.overlap);p=++M);return{x:I?I.val:k.x-i.x,y:J?J.val:k.y-i.y}},p.current=function(){var a,b,c,d,e;if(p.missies)for(e=p.missies,a=c=0,d=e.length;d>c;a=++c)if(b=e[a],b.box.miss_visible)return{index:a,missie:b}},t=function(a){var b,c;return(b=p.current())?(c=a.getElementsByClassName("miss-step-num")[0],c.innerHTML="<p>"+(b.index+1||1)+"/"+p.missies.length+"</p>"):void 0},p.next=function(){var a;return(a=p.current())?(a.missie.off(),p.missies[a.index+1]?p.missies[a.index+1].on():p.done()):void 0},p.previous=function(){var a;return(a=p.current())?(a.missie.off(),p.missies[a.index-1]?p.missies[a.index-1].on():p.off()):void 0},p.first=function(){var a;return(a=p.current())?(a.missie.off(),p.missies[0].on()):void 0},p.last=function(){var a;return(a=p.current())?(a.missie.off(),p.missies[p.missies.length-1].on()):void 0},q=function(){return(!window.localStorage[""+p.site+":missDisable"]||p.global.always_show)&&(p.global.check_url?i():p.global.show_on_load&&p.on(null,!0)),w()},i=function(){var a,b,c;return a=p.global,b=function(){var a;return 4===c.readyState?200===(a=c.status)||0===a?d(JSON.parse(c.responseText)):console.error("miss: check_url not returning expected results"):void 0},c=new XMLHttpRequest,c.onreadystatechange=b,c.open(a.check_method,p.global.check_url,!0),c.send()},d=function(a){var b,c;return b=p.global.check_keyname,c=s(a,b),c?p.on(null,!0):void 0},v=function(){var a,b,c,d,e;for(f(),d=p.missies,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.resize());return e},window.onresize=function(){return v()},window.onscroll=function(){return v()},window.onorientationchange=function(){return v()},r=function(a){var b;return p.current()&&(b=a.which||a.char||a.charCode||a.key||a.keyCode,37===b&&p.previous(),39===b&&p.next(),b===parseInt(p.global.key_on,10)&&p.on(),(27===b||b===parseInt(p.global.key_off,10))&&p.off(),46===b)?p.destroy():void 0},b.addEventListener("keydown",r,!1),g=function(){var a,b,c,d,e;if(p.global.key_modifier){for(d=p.missies,e=[],b=0,c=d.length;c>b;b++)a=d[b],a.el&&a.opts.show_on_hover&&e.push(n(a));return e}},n=function(a){return a.el.addEventListener("mouseenter",a.bindOn,!1),a.el.addEventListener("mouseleave",a.bindOff,!1)},h=function(){return p.on(null,!0)},w=function(){var a,c,d,e,f,g;for(c=p.global.trigger_el,f=b.querySelectorAll.call(b,c),g=[],d=0,e=f.length;e>d;d++)a=f[d],g.push(a.addEventListener("click",h,!1));return g},p.on=function(a,b){return null==a&&(a=null),null==b&&(b=null),e(!0,a),b?p.missies[0].on():void 0},p.off=function(){var a,b,c,d;for(d=p.missies,b=0,c=d.length;c>b;b++)a=d[b],a.off();return e(!1)},p.done=function(){return window.localStorage.setItem(""+p.site+":missDisable",!0),p.off()},p.destroy=function(){var a,c,d,e,f,g,i,j,k,l,m;for(l=p.missies,g=0,j=l.length;j>g;g++)e=l[g],e.el&&(e.el.removeEventListener("mouseenter",e.bindOn,!1),e.el.removeEventListener("mouseleave",e.bindOff,!1)),e.box&&e.box.parentNode.removeChild(e.box);for(f=b.getElementById("miss-size-test"),d=p.global.trigger_el,m=b.querySelectorAll.call(b,d),i=0,k=m.length;k>i;i++)c=m[i],c.removeEventListener("click",h,!1);return f.parentNode.removeChild(f),a=b.getElementById("miss_bd"),a.parentNode.removeChild(a),b.removeEventListener("keydown",r,!1),delete A.miss},p.settings=function(a){return p.global=l({check_method:"GET",show_on_load:!0,backdrop:!0,backdrop_color:"#000",backdrop_opacity:.5,z_index:2100,highlight:!0,highlight_width:3,highlight_color:"#fff",btn_prev_text:"&#8592 prev",btn_next_text:"next &#8594",btn_done_text:"done"},a)},this.miss=p}(document)}).call(this);