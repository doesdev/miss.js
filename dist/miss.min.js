/*
 *  Miss.js - v1.0.0
 *  Make it simple stupid. Web app walkthroughs for maximum user conversion.
 *  https://github.com/musocrat/miss
 *
 *  Made by Andrew Carpenter
 *  Under MIT License
 */
(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};!function(b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y=this;return o=function(a){var d,e,f,h,i,j,l,m,q,r,s,t,u,v;if(o.missies=o.missies||[],o.global||o.settings(a.settings||null),l=function(){return{order:"series",background_color:"#f5f5f5",titlebar_color:"#939393",font_color:"#000"}},a.elements){o.off(),f=0,u=a.elements;for(h in u)if(r=u[h],d=l(),j=k(k(d,r),o.global),"welcome"===(q=h.toLowerCase())||"exit"===q)i=n(j.msg),j.title&&i&&o.missies.push(new c(q,f+=1,j,j.title,i));else for(v=b.querySelectorAll.call(b,h),s=0,t=v.length;t>s;s++)e=v[s],m=j.title||e.dataset.missTitle||null,i=n(j.msg)||n(e.dataset.missMsg)||null,m&&i&&o.missies.push(new c(e,f+=1,j,m,i));return w(),g(),p()}},c=function(){function c(b,c,d,e,f){switch(this.off=a(this.off,this),this.on=a(this.on,this),this.bindOff=a(this.bindOff,this),this.bindOn=a(this.bindOn,this),this.resize=a(this.resize,this),this.highlight=a(this.highlight,this),this.boxSizing=a(this.boxSizing,this),this.buildBox=a(this.buildBox,this),b){case"welcome":this.order=0,this.el=null;break;case"exit":this.order=1e3,this.el=null;break;default:this.order=parseInt(b.dataset.missOrder,10)||parseInt(d.order,10)||100+c,this.el=b}this.opts=d,this.title=e,this.msg=f,this.index=c,this.buildBox()}return c.prototype.buildBox=function(){var a,c,d,e,f,g,h,j;return a=b.createElement("div"),a.id="miss_"+this.order,a.className="miss-box popover",a.style.position="fixed",a.style.zIndex=this.opts.z_index+1,j=b.createElement("div"),j.className="miss-titlebar popover-title",c='<span style="float:right;cursor:pointer;" onclick="miss.off()"               class="close" aria-hidden="true">&times;</span>',j.innerHTML=this.title+c,d=b.createElement("div"),d.className="miss-msg popover-content",d.innerHTML=this.msg,e=b.createElement("div"),e.className="miss-nav",f='<div class="btn-group">                      <button class="btn btn-default" onclick="miss.previous();">prev</button>                      <button class="btn btn-default" onclick="miss.next();">next</button></div>',g='<p class="miss-step-num pull-right"></p>',e.innerHTML=f+g,o.global.theme||(h=i(this.opts.titlebar_color),a.style.backgroundColor=this.opts.background_color,a.style.borderRadius="3px",a.style.border="1px solid rgba("+h.red+", "+h.green+", "+h.blue+", 0.6)",j.style.backgroundColor=this.opts.titlebar_color,j.style.borderTopLeftRadius="3px",j.style.borderTopRightRadius="3px",j.style.padding="8px",e.style.textAlign="center",d.style.padding="8px"),a.appendChild(j),d.appendChild(e),a.appendChild(d),v(a,!1),b.body.appendChild(a),this.box=a,this.boxSizing()},c.prototype.boxSizing=function(){var a,b,c,d;return this.el&&(c=j(this.el)),a=o.bd.miss_visible||null,b=this.box.miss_visible||null,a||(o.bd.style.visibility="hidden",o.on()),b||(this.box.style.visibility="hidden",v(this.box,!0)),this.box.style.maxWidth="30%",this.box.style.maxHeight="60%",d=this.el?l(c,this.box.offsetHeight,this.box.offsetWidth):{},this.box.style.top=""+(d.x||x().height/2-this.box.offsetHeight/2)+"px",this.box.style.left=""+(d.y||x().width/2-this.box.offsetWidth/2)+"px",a||(o.bd.style.visibility="",o.off()),b?void 0:(this.box.style.visibility="",v(this.box,!1))},c.prototype.highlight=function(){var a,c,d,e;return a=j(this.el),e=this.opts.highlight?this.opts.highlight_width:0,d=b.getElementById("miss_hl_"+this.index)||b.createElement("div"),d.id="miss_hl_"+this.index,d.style.position="fixed",d.style.top=""+(a.top-e)+"px",d.style.left=""+(a.left-e)+"px",d.style.width=""+(a.width+e)+"px",d.style.height=""+(a.height+e)+"px",this.opts.highlight&&(d.style.border=""+e+"px solid "+this.opts.highlight_color),o.bd.appendChild(d),c=b.getElementById("miss_bd_canvas").getContext("2d"),c.save(),c.globalAlpha=1,c.globalCompositeOperation="destination-out",c.beginPath(),c.fillRect(a.left,a.top,a.width+e,a.height+e),c.fill(),c.restore()},c.prototype.resize=function(){return this.boxSizing(),this.alone||f(),this.el?this.highlight():void 0},c.prototype.bindOn=function(a){var b;switch(this.opts.key_modifier.toLowerCase()){case"alt":b="altKey";break;case"ctrl":case"control":b="ctrlKey";break;case"shift":b="shiftKey";break;case"cmd":case"command":case"meta":b="metaKey";break;default:return}return a[b]?this.on(!0):void 0},c.prototype.bindOff=function(){return this.off(!0)},c.prototype.on=function(a){return null==a&&(a=null),o.bd.visible&&!a&&o.on(),a&&o.off(),this.el&&this.highlight(),v(this.box,!0,a),s(this.box),this.alone=a},c.prototype.off=function(a){var c;return null==a&&(a=null),c=b.getElementById("miss_hl_"+this.index),c&&c.parentNode.removeChild(c),f(a),v(this.box,!1),a&&o.off(),this.alone=null},c}(),v=function(a,b){return a.style.cssText=a.style.cssText+=b?"display:block !important;":"display:none !important;",a.miss_visible=b},k=function(a,b){var c;for(c in b)a[c]=b[c];return a},r=function(a,b){var c;for(c in a)if(a.hasOwnProperty(c)){if("object"==typeof a[c])return r(a[c],b);if(c===b)return a[c]}},i=function(a){return{red:parseInt(t(a).substring(0,2),16),green:parseInt(t(a).substring(2,4),16),blue:parseInt(t(a).substring(4,6),16)}},t=function(a){return a="#"===a.charAt(0)?a.split("#")[1]:a,3===a.length?a+a:a},w=function(){return o.missies.sort(function(a,b){return a.order-b.order})},e=function(a){var c,d;return(c=b.getElementById("miss_bd"))||(d=o.global,c=b.createElement("div"),c.id="miss_bd",c.style.cssText="position:fixed;z-index:"+d.z_index+";top:0;right:0;bottom:0;left:0;",v(c,!1),b.body.appendChild(c)),o.bd=c,f(),v(c,a)},f=function(){var a,c,d,e,f;return f=x(),e=o.global,(c=b.getElementById("miss_bd_canvas"))||(a=o.bd,c=b.createElement("canvas"),c.id="miss_bd_canvas",a.appendChild(c)),c.width=f.width,c.height=f.height,d=c.getContext("2d"),d.clearRect(0,0,c.width,c.height),d.globalAlpha=e.backdrop_opacity,d.fillStyle="#"+t(e.backdrop_color),d.fillRect(0,0,f.width,f.height)},n=function(a){var c;return/#{(.*?)}/.test(a)?(c=b.querySelector(a.match(/#{(.*?)}/)[1]),v(c,!1),c.innerHTML):a},j=function(a){var b,c;return c=a.getBoundingClientRect(),b=o.global.highlight?o.global.highlight_width:0,{top:c.top-b,right:c.right+b,bottom:c.bottom+b,left:c.left-b,width:c.width||c.right-c.left,height:c.height||c.bottom-c.top}},x=function(){var a;return(a=b.getElementById("miss-size-test"))||(a=b.createElement("div"),a.id="miss-size-test",a.style.cssText="position: fixed;top: 0;left: 0;bottom: 0;right: 0; visibility: hidden;",b.body.appendChild(a)),{height:a.offsetHeight,width:a.offsetWidth}},l=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q;for(g=[],h=[],k={x:x().height/2,y:x().width/2},m={x:a.height/2,y:a.width/2},i={x:b/2,y:c/2},s={plane:"x",metric:b,array:q=[],setup:{top:null,middle:[m.x,"top"],bottom:null}},t={plane:"y",metric:c,array:r=[],setup:{left:null,middle:[m.y,"left"],right:null}},L=[s,t],I=0,K=L.length;K>I;I++){f=L[I],M=f.setup;for(y in M)e=M[y],e?(d=e[0],p=e[1]):(d=0,p=y),l={},l[Object.keys(f.setup)[0]]=Math.abs(a[p]-i[f.plane]-k[f.plane]+d),l[Object.keys(f.setup)[1]]=Math.abs(a[p]-k[f.plane]+d),l[Object.keys(f.setup)[2]]=Math.abs(a[p]+i[f.plane]-k[f.plane]+d),B={},B[Object.keys(f.setup)[0]]=a[p]-f.metric+d,B[Object.keys(f.setup)[1]]=a[p]-i[f.plane]+d,B[Object.keys(f.setup)[2]]=a[p]+d,z=y,f.array.push({diff:l,val:B,position:z})}for(o in q){A=q[o],N=A.diff;for(D in N)E=N[D],g.push(E)}for(o in r){A=r[o],O=A.diff;for(G in O)H=O[G],h.push(H)}u=g.sort(function(a,b){return a-b})[0],v=h.sort(function(a,b){return a-b})[0];for(o in q){A=q[o],P=A.diff;for(D in P)if(E=P[D],E===u){B=A.val[D],w=B<a.top+a.height&&B+b>a.top,C={val:B,position:""+A.position+"_"+D,overlap:w},j=!0;break}if(j)break}for(n=J=0;8>=J;n=++J){j=!1;for(o in r){A=r[o],Q=A.diff;for(G in Q)if(H=Q[G],B=A.val[G],H===h[n]&&!(C.overlap&&B<a.left+a.width&&B+c>a.left)){F={val:A.val[G],position:""+A.position+"_"+G},j=!0;break}if(j)break}if(j)break}return{x:C.val,y:F.val}},o.current=function(){var a,b,c,d,e;for(e=o.missies,a=c=0,d=e.length;d>c;a=++c)if(b=e[a],b.box.miss_visible)return{index:a,missie:b}},s=function(a){var b,c;return(b=o.current())?(c=a.getElementsByClassName("miss-step-num")[0],c.innerHTML="<p>"+(b.index+1||1)+"/"+o.missies.length+"</p>"):void 0},o.next=function(){var a;return(a=o.current())?(a.missie.off(),o.missies[a.index+1]?o.missies[a.index+1].on():o.off()):void 0},o.previous=function(){var a;return(a=o.current())?(a.missie.off(),o.missies[a.index-1]?o.missies[a.index-1].on():o.off()):void 0},o.first=function(){var a;return(a=o.current())?(a.missie.off(),o.missies[0].on()):void 0},o.last=function(){var a;return(a=o.current())?(a.missie.off(),o.missies[o.missies.length-1].on()):void 0},p=function(){return o.global.check_url?h():o.global.show_on_load?o.on(null,!0):void 0},h=function(){var a,b,c;return a=o.global,b=function(){var a;return 4===c.readyState?200===(a=c.status)||0===a?d(JSON.parse(c.responseText)):console.error("miss: check_url not returning expected results"):void 0},c=new XMLHttpRequest,c.onreadystatechange=b,c.open(a.check_method,o.global.check_url,!0),c.send()},d=function(a){var b,c;return b=o.global.check_keyname,c=r(a,b),c?o.on(null,!0):void 0},u=function(){var a,b,c,d,e;for(d=o.missies,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.resize());return e},window.onresize=function(){return u()},window.onscroll=function(){return u()},window.onorientationchange=function(){return u()},q=function(a){var b;return o.current()&&(b=a.which||a.char||a.charCode||a.key||a.keyCode,37===b&&o.previous(),39===b&&o.next(),27===b&&o.off(),46===b)?o.destroy():void 0},b.addEventListener("keydown",q,!1),g=function(){var a,b,c,d,e;if(o.global.key_modifier){for(d=o.missies,e=[],b=0,c=d.length;c>b;b++)a=d[b],a.el&&e.push(m(a));return e}},m=function(a){return a.el.addEventListener("mouseenter",a.bindOn,!1),a.el.addEventListener("mouseleave",a.bindOff,!1)},o.on=function(a,b){return null==a&&(a=null),null==b&&(b=null),e(!0,a),b?o.missies[0].on():void 0},o.off=function(){var a,b,c,d;for(d=o.missies,b=0,c=d.length;c>b;b++)a=d[b],a.off();return e(!1)},o.destroy=function(){var a,c,d,e,f,g;for(g=o.missies,e=0,f=g.length;f>e;e++)c=g[e],c.el&&(c.el.removeEventListener("mouseenter",c.bindOn,!1),c.el.removeEventListener("mouseleave",c.bindOff,!1)),c.box&&c.box.parentNode.removeChild(c.box);return d=b.getElementById("miss-size-test"),d.parentNode.removeChild(d),a=b.getElementById("miss_bd"),a.parentNode.removeChild(a),b.removeEventListener("keydown",q,!1),delete y.miss},o.settings=function(a){return o.global=k({theme:null,check_url:null,check_method:"GET",check_keyname:null,show_on_load:!1,trigger_el:null,key_modifier:null,key_on:null,key_off:null,key_hover:null,backdrop:!0,backdrop_color:"#000",backdrop_opacity:.5,z_index:2100,welcome_title:null,welcome_msg:null,highlight:!0,highlight_width:3,highlight_color:"#fff"},a)},this.miss=o}(document)}).call(this);